---
name: test-driven-debugging
description: 系统化调试工作流 - 理解意图、隔离原因、最小修复
license: MIT
compatibility: opencode
---

# 测试驱动调试

系统化修复失败测试，而非随机尝试。

## 何时使用

- 任何测试失败时
- CI/CD流水线变红
- 修改代码导致现有测试失败

---

## 随机调试的问题

```
❌ 错误：看到错误 → 猜测原因 → 随机修复 → 期望有效
✅ 正确：看到错误 → 理解测试 → 隔离原因 → 最小修复
```

随机调试浪费时间，且经常引入新bug。

---

## 调试流程

### 阶段1: 理解测试（先读测试）

**在触碰任何代码之前，回答这些问题：**

```markdown
## 测试分析

### 这个测试在测什么？
[用1句话描述被测试的功能/行为]

### 期望行为是什么？
[根据测试，应该发生什么]

### 实际行为是什么？
[从错误信息看，实际发生了什么]

### 哪个断言失败了？
[失败的具体行/断言]
```

**操作：** 完整阅读测试文件。不要跳过这一步。

---

### 阶段2: 复现和隔离

**单独运行测试：**

```bash
# 只运行失败的测试
npm test -- --grep "测试名称模式"

# 或指定文件
npm test -- path/to/failing.test.ts
```

**隔离检查清单：**

- [ ] 单独运行是否失败（不是只在完整套件中）？
- [ ] 是否稳定失败（不是偶发性）？
- [ ] 完整的错误信息和堆栈跟踪是什么？

---

### 阶段3: 形成假设

**创建调试日志：**

```markdown
## 调试日志

| # | 假设 | 如何验证 | 结果 | 结论 |
|---|------|----------|------|------|
| 1 | [猜测1] | [测试方法] | ✓/✗ | [学到什么] |
| 2 | [猜测2] | [测试方法] | ✓/✗ | [学到什么] |
| 3 | [猜测3] | [测试方法] | ✓/✗ | [学到什么] |
```

**假设来源：**
- 错误信息/堆栈跟踪
- 最近的代码变更（git diff）
- 你见过的类似bug
- 依赖变更

---

### 阶段4: 二分法（卡住时）

如果原因不明显，使用二分搜索：

1. **注释掉一半测试** - 是否仍然失败？
2. **如果是** - 问题在剩余的一半
3. **如果否** - 问题在被注释的一半
4. **重复** 直到隔离出失败的行

---

### 阶段5: 最小修复

**修复原则：**

1. **最小改动** - 只修复出问题的部分
2. **保持意图** - 不要改变测试期望
3. **不重构** - 留到单独的提交

**提交前：**

```bash
# 运行特定测试
npm test -- --grep "修复的测试"

# 运行相关测试（同文件或模块）
npm test -- path/to/module/

# 运行所有测试（确保无回归）
npm test
```

---

## 常见失败模式

### 模式: "期望X但得到Y"

```
AssertionError: expected 5 to equal 3
```

**可能原因：**
- 差一错误（off-by-one）
- 错误的返回值
- 测试间状态未重置

**调试方法：** 在断言前打印/记录实际值

---

### 模式: "无法读取undefined的属性X"

```
TypeError: Cannot read property 'id' of undefined
```

**可能原因：**
- 缺少空值检查
- 异步时序问题
- Mock未正确设置

**调试方法：** 追溯undefined值的来源

---

### 模式: "超时"

```
Error: Timeout of 5000ms exceeded
```

**可能原因：**
- 异步操作未完成
- 缺少await
- 无限循环

**调试方法：** 在每个异步步骤添加日志

---

### 模式: "Mock未被调用"

```
Expected mock function to have been called, but it was not called
```

**可能原因：**
- Mock未应用到正确的模块
- 函数以不同的参数被调用
- 导入mock问题

**调试方法：** 记录mock实际收到的调用

---

## 反模式

### ❌ "我直接注释掉这个测试"
结果：技术债务累积，真正的bug被隐藏

### ❌ "我改一下测试期望让它通过"
结果：测试通过了但没有验证正确行为

### ❌ "顺便重构一下"
结果：引入新bug，掩盖真正的修复

### ❌ "这个测试不稳定，我跳过它"
结果：真正的问题从未被解决

---

## 快速参考

```
1. READ 测试 → 理解它在测什么
2. RUN 测试 → 隔离失败
3. LOG 假设 → 系统化排查
4. FIX 最小 → 最小的改动
5. VERIFY 全部 → 无回归
```
