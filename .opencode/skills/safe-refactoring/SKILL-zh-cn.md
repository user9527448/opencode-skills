---
name: safe-refactoring
description: 系统化重构协议 - 小步前进、验证变更、始终可回退、行为保持
license: MIT
compatibility: opencode
metadata:
  references:
    catalog: references/catalog/
    smells: references/smells/
    examples: examples/
    templates: templates/
---

# Safe Refactoring

> 无惧重构。小步前进，每步验证。始终保持行为。

---

## 🚨 何时激活此技能

| 触发条件 | 优先级 | 备注 |
|---------|----------|-------|
| 改进代码结构 | 高 | 代码难以理解时 |
| 减少技术债务 | 高 | 代码拖慢开发时 |
| 为新功能准备 | 中 | 添加复杂逻辑前 |
| 简化复杂代码 | 中 | 长方法、上帝类 |
| 理解遗留代码后 | 高 | 遗留代码被文档化后 |

---

## 铁律

```
重构 (n.): 对软件内部结构的更改
以使其更易于理解和修改
而不改变其可观察行为。

— Martin Fowler
```

**核心原则:**
- ✅ 更改结构但不更改行为 → **重构**
- ❌ 更改结构同时更改行为 → **重写** (不同流程)

---

## 核心原则

### 1. 🟢 开始前必须全绿

```bash
# 任何重构之前
npm test  # 必须完全通过

# 如果测试失败，先修BUG
# 重构是针对工作代码的
```

### 2. 📏 只做小步

**每步应该：**
- <15分钟内可完成
- 可独立验证
- 易于回滚

```
❌ "重构整个认证模块"
✅ "将密码验证提取为独立函数"
```

### 3. ✅ 每步验证

```bash
# 每次改动后
npm run lint        # 1. Linting 通过
npm run typecheck  # 2. 类型有效
npm test           # 3. 测试通过
npm run build      # 4. 构建成功
```

### 4. 💾 频繁提交

```bash
# 每次成功验证后
git commit -m "refactor: [描述单一改动]"
```

---

## 工作流概览

```
┌─────────────────────────────────────────────────────┐
│           重构工作流                                  │
├─────────────────────────────────────────────────────┤
│ 1. 评估     → 理解代码，测量指标                    │
│ 2. 准备    → 检查清单，定义范围                      │
│ 3. 计划      → 选择重构类型                          │
│ 4. 执行   → 循环：改动 → 测试 → 提交               │
│ 5. 验证    → 完整测试套件，推送到CI                 │
└─────────────────────────────────────────────────────┘
```

---

## 阶段 1: 评估

### 代码理解

重构前，先回答：

| 问题 | 为什么重要 |
|----------|----------------|
| 这段代码做什么? | 无法改进你不理解的东西 |
| 这段代码如何测试的? | 测试定义正确行为 |
| 谁使用这段代码? | 外部依赖可能破坏 |

### 代码指标

| 指标 | 阈值 | 行动 |
|--------|-----------|--------|
| 函数长度 | >50行 | 提取方法 |
| 圈复杂度 | >10 | 简化逻辑 |
| 参数数量 | >4 | 参数对象 |
| 嵌套深度 | >4 | 提前返回 |

---

## 阶段 2: 准备

使用 `templates/pre-refactor-checklist.md` 进行结构化准备。

### 重构前检查清单

- [ ] 测试通过 (全绿)
- [ ] 覆盖率 > 70%
- [ ] 分支干净
- [ ] 目标是一个改进
- [ ] 步骤分解为 <15 分钟

---

## 阶段 3: 计划

### 选择重构类型

基于代码异味：

| 代码异味 | 重构 | 优先级 |
|------------|-------------|----------|
| 长方法 | 提取方法 | P0 |
| 大类 | 提取类 | P0 |
| 重复代码 | 提取函数 | P1 |
| 特性 envy | 移动方法 | P1 |
| 数据泥团 | 参数对象 | P1 |
| Switch语句 | 多态 | P2 |

**完整目录:** 参见 `references/catalog/refactoring-types.md`

### 计划小步骤

使用 `templates/execution-plan.md` 进行结构化规划。

---

## 阶段 4: 执行

### 安全循环

```
1. 选择一个小改动
2. 做出改动
3. 运行测试
   ├─ 全绿 → 提交并继续
   └─ 变红 → 修复或回滚
4. 重复直到完成
```

### 测试失败时

| 步骤 | 行动 |
|------|--------|
| 1 | 回滚改动 → 测试通过? |
| 2 | 如果是: 修复引入的bug |
| 3 | 如果否: 预先存在的失败 |

**⚠️ 永远不要让测试失败**

---

## 阶段 5: 验证

```bash
# 完整验证
npm test && npm run lint && npm run build

# 推送到CI
git push
```

---

## 📁 目录结构

```
safe-refactoring/
├── SKILL.md
├── references/
│   ├── catalog/
│   │   └── refactoring-types.md    # 15种重构类型
│   └── smells/
│       └── code-smells.md            # 14种代码异味
├── examples/
│   └── scenarios/
│       └── refactoring-scenarios.md  # 真实案例
└── templates/
    ├── pre-refactor-checklist.md
    └── execution-plan.md
```

---

## 📖 参考文件

| 类别 | 位置 | 内容 |
|----------|----------|----------|
| **目录** | `references/catalog/` | 15种重构技术 |
| **异味** | `references/smells/` | 14种代码异味及修复 |
| **场景** | `examples/scenarios/` | 真实重构案例 |
| **模板** | `templates/` | 检查清单和规划 |

---

## 快速参考

```
🟢 全绿    → 开始前测试必须通过
📏 小步    → 每次一个微小改动
✅ 验证    → 每次改动后运行测试
💾 提交    → 频繁创建检查点

永远不要:
- 跳过运行测试
- 一次做多个改动
- 测试变红后继续
```

---

## 红旗 - 立即停止

| 想法 | 现实 | 行动 |
|---------|---------|--------|
| "测试拖慢我" | 没有测试就是盲干 | 始终运行测试 |
| "顺便重构这个" | 范围蔓延 | 坚持一个目标 |
| "这很简单，不需要测试" | 假设危险 | 先添加测试 |
| "让我试试这个" | 猜测 | 先分析 |

---

## 集成说明

- 与 `test-driven-debugging` 配合先添加测试
- 与 `code-review-guardian` 配合在重构后审查
- 使用 `code-complexity-optimizer` 进行算法改进

---

## 限制

- 无法重构编译后的二进制文件
- 无法重构不理解的代码
- 大规模重构需要团队协调
