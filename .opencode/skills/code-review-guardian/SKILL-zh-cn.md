---
name: code-review-guardian
description: 全面代码审查清单 - 安全性、性能、可维护性、正确性
license: MIT
compatibility: opencode
---

# 代码审查守护

像资深工程师一样审查代码，而不是只做拼写检查。

## 何时使用

- 审查Pull Request
- 完成功能后
- 合并到主分支前
- 被要求审查代码变更时

---

## 表面审查的问题

```
❌ 错误："LGTM"或只评论格式
✅ 正确：跨所有维度的系统化审查
```

表面审查会漏掉bug、安全问题和设计问题。

---

## 审查维度

按此顺序审查 - 从最关键到最不关键：

### 1. 🔒 安全性（关键 - 首先审查）

**检查：**

| 漏洞 | 关注点 |
|------|--------|
| SQL注入 | 查询中的字符串拼接 |
| XSS | HTML中未转义的用户输入 |
| CSRF | 状态变更缺少token |
| 代码中的敏感信息 | 源码中的API密钥、密码 |
| 路径遍历 | 文件路径中的用户输入 |
| 命令注入 | Shell命令中的用户输入 |

**危险信号：**

```javascript
// ❌ 危险模式
query = "SELECT * FROM users WHERE id = " + userId
exec(userInput)
fs.readFile(path + userInput)
innerHTML = userInput
```

```javascript
// ✅ 安全模式
query = db.query("SELECT * FROM users WHERE id = ?", [userId])
// 使用参数化查询、转义、白名单
```

**安全检查清单：**

- [ ] 所有用户输入都已验证
- [ ] 无硬编码的敏感信息/凭证
- [ ] 存在认证/授权
- [ ] 敏感数据已加密
- [ ] 公共端点有速率限制

---

### 2. 🎯 正确性（关键）

**验证：**

| 方面 | 要问的问题 |
|------|------------|
| 逻辑 | 这是否做了它应该做的事？ |
| 边界情况 | 空值/空/边界值会怎样？ |
| 错误处理 | 错误是否被正确捕获和处理？ |
| 竞态条件 | 并发运行会怎样？ |
| 数据完整性 | 这会破坏数据吗？ |

**正确性检查清单：**

- [ ] 正常路径工作正常
- [ ] 错误情况已处理
- [ ] null/undefined输入已处理
- [ ] 边界条件已考虑
- [ ] 无差一错误

---

### 3. ⚡ 性能（重要）

**关注：**

| 问题 | 模式 | 修复 |
|------|------|------|
| N+1查询 | 循环中查询 | 批量查询 |
| 内存泄漏 | 资源未关闭 | 使用cleanup/finally |
| 不必要的工作 | 冗余计算 | 缓存/记忆化 |
| 大负载 | 返回太多数据 | 分页/投影 |
| 阻塞I/O | 同步操作 | 异步模式 |

**性能危险信号：**

```javascript
// ❌ N+1查询模式
for (const user of users) {
  const posts = await db.query(`SELECT * FROM posts WHERE user_id = ?`, [user.id])
}

// ✅ 批量查询
const posts = await db.query(`SELECT * FROM posts WHERE user_id IN (?)`, [userIds])
```

**性能检查清单：**

- [ ] 无N+1查询
- [ ] 无不必要的循环/迭代
- [ ] 资源正确释放
- [ ] 热路径考虑了缓存
- [ ] 数据库查询已优化

---

### 4. 🧹 可维护性（重要）

**评估：**

| 方面 | 好 | 坏 |
|------|---|---|
| 命名 | `getUserById` | `get` 或 `func1` |
| 函数长度 | <30行 | >100行 |
| 复杂度 | 单一职责 | 做多件事 |
| DRY | 提取复用逻辑 | 复制粘贴代码 |
| 注释 | 解释"为什么" | 解释代码"做什么" |

**可维护性检查清单：**

- [ ] 名称自描述
- [ ] 函数只做一件事
- [ ] 无深层嵌套（>3层）
- [ ] 魔法数字是常量
- [ ] 复杂逻辑有注释

---

### 5. 🧪 测试（重要）

**检查：**

| 问题 | 期望 |
|------|------|
| 是否添加了新测试？ | 是，针对新代码 |
| 测试是否覆盖边界情况？ | 是，不只是正常路径 |
| 测试是否可读？ | 意图清晰，不晦涩 |
| 测试是否通过？ | 全绿 |
| Mock是否合适？ | 不要过度mock |

**测试检查清单：**

- [ ] 新代码有测试
- [ ] 测试覆盖边界情况
- [ ] 测试可读
- [ ] 无理由不跳过测试
- [ ] Mock不掩盖真实问题

---

### 6. 📚 文档（锦上添花）

**审查：**

- [ ] 公共API已文档化
- [ ] 复杂逻辑已解释
- [ ] README已更新（如需要）
- [ ] 破坏性变更已说明

---

## 审查工作流

### 步骤1: 理解上下文

```markdown
## 上下文检查清单

- [ ] 阅读PR描述
- [ ] 理解要解决的问题
- [ ] 检查关联的issue/ticket
- [ ] 注意提到的设计决策
```

### 步骤2: 快速扫描

第一遍 - 获取全局视角：

1. 修改了哪些文件？
2. 增删了多少行？
3. 大致采用什么方法？

### 步骤3: 深度审查

第二遍 - 使用上述维度：

1. 首先安全性
2. 然后正确性
3. 然后性能
4. 然后可维护性
5. 然后测试

### 步骤4: 提供反馈

**好的反馈格式：**

```markdown
## 审查总结

### 🔴 必须修复（阻塞）
- [问题1]: [描述] (文件:行号)

### 🟡 建议考虑（非阻塞）
- [问题2]: [建议]

### 🟢 锦上添花
- [小改进]

### ✅ 做得好的地方
- [正面观察]
```

---

## 反馈原则

### ❌ 糟糕的反馈

```
"这不对"
"LGTM"
"为什么这样做？"
```

### ✅ 好的反馈

```
"这可能导致SQL注入。请使用参数化查询：
cursor.query('SELECT * FROM users WHERE id = ?', [userId])"

"解决了上面的安全问题后LGTM。认证模块的重构很干净，测试也很充分。"

"我很好奇这个方法 - 你考虑过用X吗？
可能更简单，因为Y。"
```

**好的反馈是：**
- 具体的（文件:行号）
- 建设性的（建议解决方案）
- 有解释的（说明为什么重要）
- 友好的（语气很重要）

---

## 快速参考卡

```
🔒 安全性    → 首先，总是
🎯 正确性    → 能正常工作吗？
⚡ 性能      → 有N+1？内存泄漏？
🧹 可维护性  → 可读？DRY？
🧪 测试      → 覆盖了？边界情况？
📚 文档      → 更新了？
```

---

## 反模式

### ❌ 不读就说"LGTM"
结果：bug漏过

### ❌ 第一遍就纠结格式
结果：漏掉关键问题

### ❌ 模糊不清（"这不好"）
结果：开发者不知道怎么修

### ❌ 只找问题
结果：令人沮丧，漏掉做得好的地方
