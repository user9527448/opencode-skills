---
name: code-review-guardian
description: OWASP对齐的全面代码审查 - 安全性、正确性、性能、可维护性、测试、文档
license: MIT
compatibility: opencode
---

# 代码审查守护

像资深工程师一样审查代码。安全第一，永远如此。

---

## 🚨 何时激活此技能

| 触发条件 | 优先级 |
|----------|--------|
| Pull Request审查 | 高 |
| 合并前检查 | 高 |
| 安全审计 | 关键 |
| 实现后审查 | 中 |
| 代码质量检查 | 中 |

---

## 审查顺序（关键 → 锦上添花）

```
1. 🔒 安全性    → 永远第一
2. 🎯 正确性    → 能正常工作吗？
3. ⚡ 性能      → 有瓶颈吗？
4. 🧹 可维护性  → 可读？DRY？
5. 🧪 测试      → 覆盖了？
6. 📚 文档      → 更新了？
```

---

## 1. 🔒 安全性审查（永远第一）

### OWASP Top 10 快速检查

| # | 风险 | 关注点 | 严重性 |
|---|------|--------|--------|
| A01 | 访问控制失效 | 缺少认证检查，IDOR | 🔴 关键 |
| A02 | 加密失败 | 弱算法，硬编码密钥 | 🔴 关键 |
| A03 | 注入 | SQL/命令中字符串拼接 | 🔴 关键 |
| A04 | 不安全设计 | 缺少安全控制 | 🟡 高 |
| A05 | 配置错误 | 默认凭证，详细错误 | 🟡 高 |
| A06 | 易受攻击组件 | 过时的包 | 🟡 高 |
| A07 | 认证失败 | 弱密码，缺少MFA | 🔴 关键 |
| A08 | 数据完整性 | 未验证输入 | 🟡 高 |
| A09 | 日志失败 | 缺少审计跟踪 | 🟡 高 |
| A10 | SSRF | URL中的用户输入 | 🟡 高 |

### 安全代码模式

**❌ 危险模式：**
```javascript
// SQL注入
query = "SELECT * FROM users WHERE id = " + userId

// 命令注入
exec(userInput)

// 路径遍历
fs.readFile(path + userInput)

// XSS
innerHTML = userInput

// 硬编码密钥
const apiKey = "sk-abc123..."
```

**✅ 安全模式：**
```javascript
// 参数化查询
db.query("SELECT * FROM users WHERE id = ?", [userId])

// 白名单验证
const allowed = ['option1', 'option2'];
if (!allowed.includes(input)) throw new Error();

// 环境变量
const apiKey = process.env.API_KEY

// 输出编码
textContent = escapeHtml(userInput)
```

### 安全检查清单

- [ ] 所有用户输入已验证和清理
- [ ] 无硬编码凭证或密钥
- [ ] 受保护路由有认证
- [ ] 操作前检查授权
- [ ] 敏感数据静态和传输加密
- [ ] 公共端点有速率限制
- [ ] CORS配置正确
- [ ] 安全头存在（CSP, HSTS）
- [ ] 依赖检查漏洞

---

## 2. 🎯 正确性审查

### 逻辑验证

| 检查 | 问题 |
|------|------|
| 正常路径 | 主流程能工作吗？ |
| 边界情况 | null、空、边界值？ |
| 错误处理 | 所有错误都被捕获处理？ |
| 竞态条件 | 并发访问安全？ |
| 数据完整性 | 会破坏数据吗？ |

### 正确性检查清单

- [ ] 逻辑匹配需求
- [ ] 所有分支可达且测试
- [ ] Null/undefined已处理
- [ ] 空数组/对象已处理
- [ ] 边界条件已检查
- [ ] 错误信息有帮助
- [ ] 无静默失败

---

## 3. ⚡ 性能审查

### 常见性能问题

| 问题 | 模式 | 检测 |
|------|------|------|
| N+1查询 | 循环中查询 | 找`for...await` |
| 内存泄漏 | 资源未关闭 | 缺少`finally`或清理 |
| 不必要工作 | 冗余计算 | 重复函数调用 |
| 大负载 | 数据太多 | 检查响应大小 |
| 阻塞I/O | 同步操作 | `readFileSync` |

### 性能模式

**❌ N+1查询：**
```javascript
for (const user of users) {
  const posts = await db.query(`SELECT * FROM posts WHERE user_id = ?`, [user.id])
}
```

**✅ 批量查询：**
```javascript
const userIds = users.map(u => u.id)
const posts = await db.query(`SELECT * FROM posts WHERE user_id IN (?)`, [userIds])
```

---

## 4. 🧹 可维护性审查

| 方面 | 好 | 坏 |
|------|---|---|
| 命名 | `getUserById` | `get`, `func1` |
| 长度 | <30行 | >100行 |
| 复杂度 | 单一职责 | 多个关注点 |
| DRY | 提取工具函数 | 复制粘贴 |
| 注释 | 解释"为什么" | 解释"做什么" |

---

## 5. 🧪 测试审查

| 问题 | 期望 |
|------|------|
| 新增测试了吗？ | 是，针对新代码 |
| 边界情况覆盖？ | 不只是正常路径 |
| 测试可读？ | 意图清晰 |
| 所有测试通过？ | 全绿 |
| Mock合适？ | 不要过度mock |

---

## 6. 📚 文档审查

- [ ] 公共API已文档化
- [ ] 复杂逻辑已解释
- [ ] README已更新（如需要）
- [ ] 破坏性变更已说明

---

## 审查输出模板

```markdown
## 代码审查摘要

### 🔴 必须修复（阻塞）
- [安全] [文件:行号] - SQL注入漏洞
- [逻辑] [文件:行号] - 缺少空值检查

### 🟡 建议考虑（非阻塞）
- [性能] 考虑批量查询
- [风格] 变量名可以更具描述性

### 🟢 做得好的地方
- 关注点分离清晰
- 新功能测试覆盖好

### ✅ 总体
[批准 / 需要修改 / 评论]
```

---

## 反馈原则

### ❌ 糟糕反馈
```
"这不对"
"LGTM"
"为什么这样做？"
```

### ✅ 好反馈
```
"这可能导致SQL注入。请使用参数化查询：
cursor.query('SELECT * FROM users WHERE id = ?', [userId])"

"解决安全问题后LGTM。
重构很干净，测试也很充分。"
```

---

## 快速参考卡

```
🔒 安全性    → 第一，永远
   □ 注入风险
   □ 认证授权
   □ 代码中的密钥
   
🎯 正确性    → 按预期工作？
   □ 边界情况
   □ 错误处理
   
⚡ 性能      → 可扩展？
   □ N+1查询
   □ 内存泄漏
   
🧹 可维护性  → 可读？
   □ 命名
   □ 复杂度
   
🧪 测试      → 覆盖了？
   □ 新测试
   □ 边界情况
   
📚 文档      → 更新了？
   □ API文档
   □ README
```
