---
name: code-review-guardian
description: OWASP对齐的全面代码审查 - 安全性、正确性、性能、可维护性、测试、文档、架构、并发
license: MIT
compatibility: opencode
---

# 代码审查守护

像资深工程师一样审查代码。安全第一，永远如此。输出标准化报告。

---

## 🚨 何时激活此技能

| 触发条件 | 优先级 |
|----------|--------|
| Pull Request审查 | 高 |
| 合并前检查 | 高 |
| 安全审计 | 关键 |
| 实现后审查 | 中 |
| 代码质量检查 | 中 |

---

## 📋 执行工作流

### 步骤 1: 确定范围
```
1. 识别变更文件 (git diff, PR文件列表)
2. 确定审查深度 (quick/full/security-only)
3. 记录语言/框架上下文
```

### 步骤 2: 自动扫描 (使用工具)
```
1. LSP诊断 → 类型错误、lint问题
2. AST-grep → 基于模式的安全/质量检查
3. Grep → 查找TODOs、FIXMEs、硬编码值
4. 依赖检查 → 已知漏洞
```

### 步骤 3: 人工审查 (按维度)
```
审查顺序: 安全性 → 正确性 → 架构 → 性能 
         → 可维护性 → 并发 → 测试 → 文档
```

### 步骤 4: 生成报告
```
输出标准markdown报告，包含:
- 执行摘要
- 分类发现
- 按严重性排序的行动项
- 具体修复建议
```

---

## 审查维度 (关键 → 锦上添花)

```
1. 🔒 安全性     → 永远第一
2. 🎯 正确性     → 能正常工作吗？
3. 🏗️ 架构       → 设计模式、SOLID
4. ⚡ 性能       → 有瓶颈吗？
5. 🧹 可维护性   → 可读？DRY？
6. 🔄 并发       → 线程/进程安全？
7. ♿ 可访问性    → 前端a11y
8. 🧪 测试       → 覆盖了？
9. 📚 文档       → 更新了？
```

---

## 1. 🔒 安全性审查（永远第一）

### OWASP Top 10 快速检查

| # | 风险 | 关注点 | 严重性 |
|---|------|--------|--------|
| A01 | 访问控制失效 | 缺少认证检查，IDOR | 🔴 关键 |
| A02 | 加密失败 | 弱算法，硬编码密钥 | 🔴 关键 |
| A03 | 注入 | SQL/命令中字符串拼接 | 🔴 关键 |
| A04 | 不安全设计 | 缺少安全控制 | 🟡 高 |
| A05 | 配置错误 | 默认凭证，详细错误 | 🟡 高 |
| A06 | 易受攻击组件 | 过时的包 | 🟡 高 |
| A07 | 认证失败 | 弱密码，缺少MFA | 🔴 关键 |
| A08 | 数据完整性 | 未验证输入 | 🟡 高 |
| A09 | 日志失败 | 缺少审计跟踪 | 🟡 高 |
| A10 | SSRF | URL中的用户输入 | 🟡 高 |

### 安全代码模式

**❌ 危险模式：**
```javascript
// SQL注入
query = "SELECT * FROM users WHERE id = " + userId

// 命令注入
exec(userInput)

// 路径遍历
fs.readFile(path + userInput)

// XSS
innerHTML = userInput

// 硬编码密钥
const apiKey = "sk-abc123..."
```

**✅ 安全模式：**
```javascript
// 参数化查询
db.query("SELECT * FROM users WHERE id = ?", [userId])

// 白名单验证
const allowed = ['option1', 'option2'];
if (!allowed.includes(input)) throw new Error();

// 环境变量
const apiKey = process.env.API_KEY

// 输出编码
textContent = escapeHtml(userInput)
```

### 安全检查清单

- [ ] 所有用户输入已验证和清理
- [ ] 无硬编码凭证或密钥
- [ ] 受保护路由有认证
- [ ] 操作前检查授权
- [ ] 敏感数据静态和传输加密
- [ ] 公共端点有速率限制
- [ ] CORS配置正确
- [ ] 安全头存在（CSP, HSTS）
- [ ] 依赖检查漏洞

---

## 2. 🎯 正确性审查

### 逻辑验证

| 检查 | 问题 |
|------|------|
| 正常路径 | 主流程能工作吗？ |
| 边界情况 | null、空、边界值？ |
| 错误处理 | 所有错误都被捕获处理？ |
| 竞态条件 | 并发访问安全？ |
| 数据完整性 | 会破坏数据吗？ |
| 类型安全 | 类型正确一致？ |

### 错误处理模式

**❌ 错误：**
```javascript
try { doSomething() } catch(e) {} // 静默失败
if (error) throw "Error occurred" // 通用消息
```

**✅ 正确：**
```javascript
try {
  await doSomething()
} catch (error) {
  logger.error('Failed to do something', { context, error })
  throw new SpecificError('Descriptive message', { cause: error })
}
```

### 正确性检查清单

- [ ] 逻辑匹配需求
- [ ] 所有分支可达且测试
- [ ] Null/undefined已处理
- [ ] 空数组/对象已处理
- [ ] 边界条件已检查
- [ ] 错误信息有帮助且具体
- [ ] 无静默失败
- [ ] 类型断言避免`as any`

---

## 3. 🏗️ 架构审查

### 设计原则 (SOLID)

| 原则 | 检查 |
|------|------|
| 单一职责 | 每个类/函数只做一件事？ |
| 开闭原则 | 可扩展而不修改？ |
| 里氏替换 | 子类型可替换？ |
| 接口隔离 | 接口聚焦？ |
| 依赖倒置 | 依赖注入？ |

### 常见问题

| 问题 | 检测 |
|------|------|
| 上帝类 | 类>500行，>10个方法 |
| 循环依赖 | 导入循环 |
| 紧耦合 | 到处直接实例化 |
| 基本类型偏执 | 使用基本类型而非类型 |
| 特征嫉妒 | 方法更多使用另一个类 |

### 架构模式

| 模式 | 使用场景 |
|------|----------|
| 仓储 | 数据访问抽象 |
| 工厂 | 复杂对象创建 |
| 策略 | 可互换算法 |
| 观察者 | 事件驱动更新 |
| 装饰器 | 不继承添加行为 |

### 架构检查清单

- [ ] 关注点分离清晰
- [ ] 依赖单向流动
- [ ] 无循环依赖
- [ ] 外部依赖使用接口
- [ ] 保持单一职责
- [ ] 应用了适当的设计模式

---

## 4. ⚡ 性能审查

### 常见性能问题

| 问题 | 模式 | 检测 |
|------|------|------|
| N+1查询 | 循环中查询 | 找`for...await` |
| 内存泄漏 | 资源未关闭 | 缺少`finally`或清理 |
| 不必要工作 | 冗余计算 | 重复函数调用 |
| 大负载 | 数据太多 | 检查响应大小 |
| 阻塞I/O | 同步操作 | `readFileSync` |
| 未优化循环 | 热路径O(n²) | 嵌套循环 |

### 性能模式

**❌ N+1查询：**
```javascript
for (const user of users) {
  const posts = await db.query(`SELECT * FROM posts WHERE user_id = ?`, [user.id])
}
```

**✅ 批量查询：**
```javascript
const userIds = users.map(u => u.id)
const posts = await db.query(`SELECT * FROM posts WHERE user_id IN (?)`, [userIds])
```

### 性能检查清单

- [ ] 无N+1查询
- [ ] 无不必要循环
- [ ] 资源正确释放
- [ ] 热路径考虑缓存
- [ ] 数据库查询使用索引
- [ ] 大列表分页
- [ ] 适当懒加载
- [ ] Async/await不阻塞

---

## 5. 🧹 可维护性审查

### 代码质量指标

| 方面 | 好 | 坏 |
|------|---|---|
| 命名 | `getUserById` | `get`, `func1` |
| 长度 | <30行 | >100行 |
| 复杂度 | 单一职责 | 多个关注点 |
| DRY | 提取工具函数 | 复制粘贴 |
| 注释 | 解释"为什么" | 解释"做什么" |
| 圈复杂度 | <10 | >20 |

### 圈复杂度阈值

| 分数 | 风险 | 行动 |
|------|------|------|
| 1-10 | 低 | 可接受 |
| 11-20 | 中 | 考虑重构 |
| 21-50 | 高 | 需要重构 |
| 50+ | 很高 | 必须重构 |

### 可维护性检查清单

- [ ] 名称自描述
- [ ] 函数只做一件事
- [ ] 嵌套≤3层
- [ ] 魔法数字是常量
- [ ] 复杂逻辑有注释
- [ ] 无死代码
- [ ] 与代码库风格一致
- [ ] 无深层嵌套（早返回）

---

## 6. 🔄 并发审查

### 并发问题

| 问题 | 描述 | 检测 |
|------|------|------|
| 竞态条件 | 多线程访问共享数据 | 共享可变状态 |
| 死锁 | 循环等待资源 | 多个锁 |
| 活锁 | 线程无尽响应彼此 | 复杂同步逻辑 |
| 饥饿 | 线程被拒绝资源 | 优先级问题 |

### 线程安全模式

**❌ 不安全：**
```javascript
let counter = 0
async function increment() {
  const current = counter  // 竞态条件
  await someAsyncOp()
  counter = current + 1
}
```

**✅ 安全：**
```javascript
const mutex = new Mutex()
let counter = 0
async function increment() {
  await mutex.runExclusive(async () => {
    counter++
  })
}
```

### 并发检查清单

- [ ] 共享状态正确同步
- [ ] 无竞态条件
- [ ] 锁以一致顺序获取
- [ ] 等待有超时
- [ ] 优先不可变数据
- [ ] 原子操作正确使用

---

## 7. ♿ 可访问性审查（前端）

### WCAG 2.1 快速检查

| 类别 | 检查 |
|------|------|
| 可感知 | Alt文本、字幕、颜色对比 |
| 可操作 | 键盘导航、焦点可见、无陷阱 |
| 可理解 | 清晰语言、一致导航 |
| 健壮 | 有效HTML、ARIA正确 |

### 常见A11y问题

```html
<!-- ❌ 错误 -->
<button onclick="submit()">Submit</button>
<img src="chart.png">
<div class="modal" style="display:none">

<!-- ✅ 正确 -->
<button type="button" onclick="submit()">Submit</button>
<img src="chart.png" alt="第四季度销售增长20%">
<div class="modal" role="dialog" aria-hidden="true">
```

### 可访问性检查清单

- [ ] 所有图片有意义的alt文本
- [ ] 表单有关联标签
- [ ] 颜色对比度≥4.5:1
- [ ] 焦点指示器可见
- [ ] ARIA属性正确
- [ ] 键盘导航可用

---

## 8. 🧪 测试审查

### 测试质量检查

| 问题 | 期望 |
|------|------|
| 新增测试了吗？ | 是，针对新代码 |
| 边界情况覆盖？ | 不只是正常路径 |
| 测试可读？ | 意图清晰 |
| 所有测试通过？ | 全绿 |
| Mock合适？ | 不要过度mock |
| 断言具体？ | 不只是"存在" |

### 测试模式

**❌ 弱测试：**
```javascript
test('user creation', async () => {
  const result = await createUser({ name: 'test' })
  expect(result).toBeDefined()
})
```

**✅ 强测试：**
```javascript
test('creates user with valid data and returns user object', async () => {
  const input = { name: 'test', email: 'test@example.com' }
  const result = await createUser(input)
  
  expect(result).toMatchObject({
    id: expect.any(String),
    name: 'test',
    email: 'test@example.com',
    createdAt: expect.any(Date)
  })
})
```

### 测试检查清单

- [ ] 新代码有测试
- [ ] 边界情况测试（null、空、边界）
- [ ] 测试可读
- [ ] 无跳过测试（无理由）
- [ ] 测试名称描述行为
- [ ] 断言具体
- [ ] Mock不隐藏真实问题

---

## 9. 📚 文档审查

### 文档检查清单

- [ ] 公共API已文档化（JSDoc/docstrings）
- [ ] 复杂逻辑在注释中解释
- [ ] README已更新（如需要）
- [ ] 破坏性变更已说明
- [ ] 提供示例
- [ ] 类型定义准确
- [ ] 错误码已文档化

---

## 📊 标准审查报告模板

完成审查后，按以下格式输出markdown报告：

```markdown
# 代码审查报告

**审查日期**: {日期}
**审查者**: AI代码审查守护
**审查文件**: {文件列表}
**审查范围**: {quick|full|security-only}

---

## 执行摘要

| 指标 | 数量 |
|------|------|
| 🔴 关键 | {n} |
| 🟠 高 | {n} |
| 🟡 中 | {n} |
| 🟢 低 | {n} |
| ✅ 通过 | {维度} |

**总体结论**: {批准 | 需要修改 | 阻塞}

---

## 🔴 关键问题（合并前必须修复）

### CRIT-001: {问题标题}
- **类别**: 安全
- **文件**: `{文件路径}:{行号}`
- **描述**: {什么问题}
- **影响**: {为什么重要}
- **代码**:
  ```{语言}
  // 当前问题代码
  ```
- **建议修复**:
  ```{语言}
  // 修正后代码
  ```
- **参考**: {OWASP/CWE/最佳实践链接}

---

## 🟠 高优先级问题

### HIGH-001: {问题标题}
- **类别**: {类别}
- **文件**: `{文件路径}:{行号}`
- **描述**: {什么问题}
- **建议修复**: {如何修复}

---

## 🟡 中等优先级问题

### MED-001: {问题标题}
- **类别**: {类别}
- **文件**: `{文件路径}:{行号}`
- **描述**: {什么问题}
- **建议修复**: {如何修复}

---

## 🟢 低优先级 / 小问题

### LOW-001: {问题标题}
- **类别**: 风格/可维护性
- **文件**: `{文件路径}:{行号}`
- **描述**: {什么问题}
- **建议修复**: {如何修复}

---

## ✅ 做得好的地方

1. {正面观察及具体示例}
2. {另一个正面}
3. {另一个正面}

---

## 📋 检查清单摘要

### 安全性
- [x] 输入验证
- [ ] 无硬编码密钥
- [x] 认证存在
- [ ] 授权检查

### 正确性
- [x] 逻辑匹配需求
- [x] 边界情况处理
- [ ] 错误消息具体

### 架构
- [x] 单一职责
- [x] 无循环依赖
- [ ] 使用依赖注入

### 性能
- [x] 无N+1查询
- [x] 资源释放
- [ ] 实现缓存

### 可维护性
- [x] 清晰命名
- [x] 函数<30行
- [ ] 圈复杂度<10

### 测试
- [x] 新代码已测试
- [ ] 边界情况已测试
- [x] 所有测试通过

### 文档
- [x] 公共API已文档化
- [ ] 复杂逻辑已解释

---

## 🔧 建议行动

| 优先级 | 行动 | 工作量 |
|--------|------|--------|
| 🔴 P0 | 修复auth.ts中的SQL注入 | 15分钟 |
| 🟠 P1 | 在user.service.ts中添加空值检查 | 10分钟 |
| 🟡 P2 | 将验证逻辑提取到单独文件 | 30分钟 |
| 🟢 P3 | 改进变量命名 | 5分钟 |

---

## 📝 备注

{任何额外上下文、未来改进建议或架构考虑}

---

**审查完成**: {时间戳}
**建议下次审查**: {修复后 / 1周后 / 按需}
```

---

## 反馈原则

### ❌ 糟糕反馈
```
"这不对"
"LGTM"
"为什么这样做？"
```

### ✅ 好反馈
```
"[CRIT-001] auth.ts:45处SQL注入漏洞
请使用参数化查询代替字符串拼接：
cursor.query('SELECT * FROM users WHERE id = ?', [userId])
参考：OWASP A03:2021"
```

**好反馈是：**
- 具体的（文件:行号）
- 建设性的（建议解决方案）
- 解释的（为什么重要）
- 分类的（严重性+类别）
- 可操作的（明确下一步）

---

## 快速参考卡

```
📋 执行顺序
1. 确定范围 → 2. 自动扫描 → 3. 人工审查 → 4. 生成报告

🔒 安全性    → 第一，永远
   □ 注入风险（SQL, CMD, XSS）
   □ 认证授权缺失
   □ 代码中的密钥
   □ 输入验证

🎯 正确性    → 按预期工作？
   □ 边界情况（null、空、边界）
   □ 错误处理
   □ 类型安全

🏗️ 架构      → 设计良好？
   □ SOLID原则
   □ 无循环依赖
   □ 关注点分离

⚡ 性能      → 可扩展？
   □ N+1查询
   □ 内存泄漏
   □ 阻塞I/O

🧹 可维护性  → 可读？
   □ 命名清晰
   □ 复杂度<10
   □ DRY原则

🔄 并发      → 线程安全？
   □ 竞态条件
   □ 正确加锁

♿ 可访问性  → A11y合规？
   □ Alt文本
   □ 键盘导航
   □ 颜色对比

🧪 测试      → 覆盖了？
   □ 新代码有新测试
   □ 边界情况测试
   □ 所有测试通过

📚 文档      → 更新了？
   □ API文档
   □ README更新
   □ 破坏性变更说明

📊 输出 → 标准markdown报告
   □ 执行摘要
   □ 按严重性问题
   □ 建议修复
   □ 检查清单摘要
```
